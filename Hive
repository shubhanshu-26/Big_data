-- Create a table and load the data into the table

create TABLE airbnb_nyc_rawdata
(
id INT,
name STRING,
host_id	INT,
host_name STRING,	
neighbourhood_group STRING,
neighbourhood STRING,
latitude DOUBLE,
longitude DOUBLE,
room_type STRING,
price	INT,
minimum_nights INT,
number_of_reviews INT,
last_review	STRING,
reviews_per_month DOUBLE,	
calculated_host_listings_count INT,
availability_365 INT
) 
row format delimited 
fields terminated by ','
TBLPROPERTIES("skip.header.line.count"="1");

load data inpath '/user/febb2batc8011/airbnd_demo/NYC_2019_raw.csv'
into table airbnb_nyc_rawdata;

-- Run a query for the created table

select * from airbnb_nyc_rawdata;

select airbnb_nyc_rawdata.room_type as preference_stay, count(*) as Number_of_bookings
from airbnb_nyc_rawdata
group by airbnb_nyc_rawdata.room_type
order by preference_stay desc
limit 3;

-------------------------------------------------------------------------------------------------------------------
-- Create a external table and load the data from avro file into the table

CREATE EXTERNAL TABLE x_analysis
  ROW FORMAT SERDE
  'org.apache.hadoop.hive.serde2.avro.AvroSerDe'
  STORED AS INPUTFORMAT
  'org.apache.hadoop.hive.ql.io.avro.AvroContainerInputFormat'
  OUTPUTFORMAT
  'org.apache.hadoop.hive.ql.io.avro.AvroContainerOutputFormat'
  TBLPROPERTIES (
    'avro.schema.url'='/user/febb2batc8011/x-analysis/schema.avsc');
    
  Load data inpath '/user/febb2batc8011/x-analysis/*avro'
  into table x_analysis;

select * 
from x_analysis 
limit 10;

-------------------------------------------------------------------------------------------------------------------
-- Created a table and load the data into the table and stored as a parquet format

CREATE TABLE employee (
	emp_id INT,
	name STRING,
	department STRING,
	salary DOUBLE
)
STORED AS PARQUET;

INSERT INTO TABLE employee VALUES
(1, 'Amit', 'IT', 60000),
(2, 'Rahul', 'HR', 50000),
(3, 'Aryan', 'IT', 70000);

describe formatted employee;

-------------------------------------------------------------------------------------------------------------------
-- Partion
CREATE EXTERNAL TABLE post_office_india
(
    OFFICE_NAME       STRING,
    OFFICE_STATUS     STRING,
    PINCODE           INT,
    TELEPHONE         BIGINT,
    TALUK             STRING,
    DISTRICT          STRING,
    STATE             STRING,
    POSTAL_DIVISION   STRING,
    POSTAL_REGION     STRING,
    POSTAL_CIRCLE     STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

LOAD DATA INPATH '/user/febb2batc8011/post_office_analysis/All_States_PinCode.csv' 
INTO TABLE post_office_india;

select * from post_office_india
where state = 'RAJASTHAN';

-- Dynamic Partition

SET hive.exec.dynamic.partition = true;
SET hive.exec.dynamic.partition.mode = nonstrict;

CREATE TABLE post_office_district (
    OFFICE_NAME STRING,
    OFFICE_STATUS     STRING,
    PINCODE           INT,
    TELEPHONE   BIGINT,
    TALUK       STRING,
    DISTRICT STRING,
    POSTAL_DIVISION   STRING,
    POSTAL_REGION     STRING,
    POSTAL_CIRCLE     STRING
)
PARTITIONED BY (STATE STRING)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

insert overwrite table post_office_district 
partition (STATE) select * from post_office_india;

-- Static Partition

CREATE TABLE post_office_static (
OFFICE_NAME STRING,
OFFICE_STATUS     STRING,
PINCODE           INT,
TELEPHONE   BIGINT,
TALUK       STRING,
DISTRICT    STRING,
POSTAL_DIVISION   STRING,
POSTAL_REGION     STRING,
POSTAL_CIRCLE     STRING
)
PARTITIONED BY (STATE STRING)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

insert overwrite table post_office_static partition (STATE = 'WEST BENGAL') 
select OFFICE_NAME,OFFICE_STATUS,PINCODE,TELEPHONE,TALUK,DISTRICT,POSTAL_DIVISION,POSTAL_REGION,POSTAL_CIRCLE
from post_office_india
where STATE = 'WEST BENGAL';

alter table post_office_static
drop partition (STATE = 'WEST BENGAL');

-------------------------------------------------------------------------------------------------------------------
-- Bucketing
set hive.enforce.bucketing = true

CREATE TABLE post_office_BUCKETS (
    OFFICE_NAME       STRING,
    OFFICE_STATUS     STRING,
    PINCODE           INT,
    TELEPHONE         BIGINT,
    TALUK             STRING,
    DISTRICT          STRING,
    STATE             STRING,
    POSTAL_DIVISION   STRING,
    POSTAL_REGION     STRING,
    POSTAL_CIRCLE     STRING
)
CLUSTERED BY (PINCODE) Into 4 BUCKETS
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

insert overwrite table post_office_BUCKETS 
select * from post_office_india;
